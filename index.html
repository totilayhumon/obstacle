<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <title>Obstacle Avoidance Game - First Person</title>
</head>
<body>
    <a-scene background="color: #87CEEB" vr-mode-ui="enabled: false">
        <!-- Player (invisible in first person) -->
        <a-box id="player" 
               position="0 1.6 0" 
               color="blue" 
               width="0.5" 
               height="1.8" 
               depth="0.5"
               visible="false">
        </a-box>
        
        <!-- Ground with texture for better depth perception -->
        <a-plane position="0 0 0" 
                 rotation="-90 0 0" 
                 width="50" 
                 height="200" 
                 color="green"
                 repeat="25 100">
        </a-plane>
        
        <!-- Fixed First Person Camera (no mouse look) -->
        <a-camera id="camera" 
                  position="0 1.6 0" 
                  look-controls="enabled: false"
                  wasd-controls="enabled: false">
            
            <!-- HUD Elements attached to camera -->
            <a-text id="scoreText" 
                    position="-1.5 1 -3" 
                    value="Score: 0" 
                    color="white"
                    scale="2 2 2">
            </a-text>
            
            <!-- Crosshair for center reference -->
            <a-ring position="0 0 -2" 
                    radius-inner="0.01" 
                    radius-outer="0.02" 
                    color="white"
                    opacity="0.5">
            </a-ring>
            
            <!-- Game Over Screen -->
            <a-text id="gameOverText" 
                    position="0 0.5 -3" 
                    value="" 
                    color="red"
                    scale="3 3 3"
                    visible="false"
                    align="center">
            </a-text>
            
            <a-text id="finalScoreText" 
                    position="0 0 -3" 
                    value="" 
                    color="red"
                    scale="2 2 2"
                    visible="false"
                    align="center">
            </a-text>
            
            <a-text id="restartText" 
                    position="0 -0.5 -3" 
                    value="Press R to Restart" 
                    color="white"
                    scale="1.5 1.5 1.5"
                    visible="false"
                    align="center">
            </a-text>

            <!-- Instructions -->
            <a-text id="instructionsText" 
                    position="0 -1 -3" 
                    value="A/D: Strafe | W/Space: Jump | S: Crouch | Dodge the shapes!" 
                    color="yellow"
                    scale="1 1 1"
                    align="center">
            </a-text>
            
            <!-- Speed indicator -->
            <a-text id="speedText" 
                    position="1.5 1 -3" 
                    value="Speed: 1.0x" 
                    color="cyan"
                    scale="1.5 1.5 1.5">
            </a-text>
        </a-camera>
        
    </a-scene>

    <script>
        // Wait for A-Frame to fully load
        document.addEventListener('DOMContentLoaded', function() {
            // Game variables
            let score = 0;
            let gameRunning = false;
            let obstacles = [];
            let playerSpeed = 0.12;
            let scoreInterval;
            let obstacleInterval;
            let gameLoopInterval;
            
            // Player variables
            let player = document.getElementById('player');
            let camera = document.getElementById('camera');
            let isJumping = false;
            let isCrouching = false;
            let playerX = 0;
            let playerY = 1.6;
            let playerZ = 0;
            
            // Movement keys
            let keys = {
                left: false,
                right: false,
                jump: false,
                crouch: false
            };
            
            // Get text elements
            let scoreText = document.getElementById('scoreText');
            let gameOverText = document.getElementById('gameOverText');
            let finalScoreText = document.getElementById('finalScoreText');
            let restartText = document.getElementById('restartText');
            let instructionsText = document.getElementById('instructionsText');
            let speedText = document.getElementById('speedText');
            
            // Obstacle shapes and colors
            const shapeTypes = ['box', 'sphere', 'cylinder', 'cone', 'dodecahedron', 'octahedron'];
            const colors = ['red', 'orange', 'purple', 'maroon', 'darkred', 'crimson'];
            
            // Start the game
            function startGame() {
                console.log('Starting game...');
                score = 0;
                gameRunning = true;
                obstacles = [];
                playerSpeed = 0.12;
                
                // Reset player position
                playerX = 0;
                playerY = 1.6;
                playerZ = 0;
                player.setAttribute('position', `${playerX} ${playerY} ${playerZ}`);
                camera.setAttribute('position', `${playerX} ${playerY} ${playerZ}`);
                player.setAttribute('height', '1.8');
                
                // Hide game over screen
                gameOverText.setAttribute('visible', false);
                finalScoreText.setAttribute('visible', false);
                restartText.setAttribute('visible', false);
                instructionsText.setAttribute('visible', true);
                
                // Reset player state
                isJumping = false;
                isCrouching = false;
                keys = { left: false, right: false, jump: false, crouch: false };
                
                // Clear any existing intervals
                if (scoreInterval) clearInterval(scoreInterval);
                if (obstacleInterval) clearInterval(obstacleInterval);
                if (gameLoopInterval) clearInterval(gameLoopInterval);
                
                // Start score counter
                scoreInterval = setInterval(() => {
                    if (gameRunning) {
                        score += 10;
                        scoreText.setAttribute('value', 'Score: ' + score);
                        // Increase difficulty over time
                        let speedMultiplier = 1 + (score * 0.00005);
                        playerSpeed = Math.min(0.25, 0.12 * speedMultiplier);
                        speedText.setAttribute('value', 'Speed: ' + speedMultiplier.toFixed(1) + 'x');
                    }
                }, 100);
                
                // Start spawning obstacles more frequently
                obstacleInterval = setInterval(spawnObstacle, 1200);
                
                // Start game loop
                gameLoopInterval = setInterval(updateGame, 16); // ~60fps
            }
            
            // Spawn various shaped obstacles around the player area
            function spawnObstacle() {
                if (!gameRunning) return;
                
                // Spawn multiple obstacles at once sometimes
                let numObstacles = Math.random() > 0.7 ? 2 : 1;
                
                for (let i = 0; i < numObstacles; i++) {
                    let obstacle = document.createElement('a-' + shapeTypes[Math.floor(Math.random() * shapeTypes.length)]);
                    
                    // Spawn in a wider area around the player's path
                    let xPos = (Math.random() - 0.5) * 16; // Much wider spawn area (-8 to 8)
                    let zPos = playerZ - (15 + Math.random() * 15); // Spawn 15-30 units ahead
                    let yPos = 0.5 + Math.random() * 2; // Random height between 0.5 and 2.5
                    
                    obstacle.setAttribute('position', `${xPos} ${yPos} ${zPos}`);
                    obstacle.setAttribute('color', colors[Math.floor(Math.random() * colors.length)]);
                    
                    // Set size based on shape type
                    let size = 0.8 + Math.random() * 1.2; // Random size between 0.8 and 2.0
                    
                    switch(obstacle.tagName.toLowerCase()) {
                        case 'a-box':
                            obstacle.setAttribute('width', size);
                            obstacle.setAttribute('height', size);
                            obstacle.setAttribute('depth', size);
                            break;
                        case 'a-sphere':
                            obstacle.setAttribute('radius', size * 0.7);
                            break;
                        case 'a-cylinder':
                            obstacle.setAttribute('radius', size * 0.6);
                            obstacle.setAttribute('height', size * 1.5);
                            break;
                        case 'a-cone':
                            obstacle.setAttribute('radius-bottom', size * 0.8);
                            obstacle.setAttribute('height', size * 1.5);
                            break;
                        default:
                            obstacle.setAttribute('radius', size * 0.7);
                    }
                    
                    obstacle.setAttribute('class', 'obstacle');
                    
                    // Add random rotation animation
                    let rotationAxis = ['x', 'y', 'z'][Math.floor(Math.random() * 3)];
                    let rotationSpeed = 2000 + Math.random() * 4000;
                    obstacle.setAttribute('animation', `property: rotation; to: ${rotationAxis === 'x' ? '360' : '0'} ${rotationAxis === 'y' ? '360' : '0'} ${rotationAxis === 'z' ? '360' : '0'}; loop: true; dur: ${rotationSpeed}`);
                    
                    document.querySelector('a-scene').appendChild(obstacle);
                    obstacles.push({
                        element: obstacle,
                        size: size
                    });
                }
            }
            
            // Update game logic
            function updateGame() {
                if (!gameRunning) return;
                
                // Move player forward automatically
                playerZ -= playerSpeed;
                
                // Handle left/right strafing
                if (keys.left && playerX > -8) {
                    playerX -= 0.15;
                }
                if (keys.right && playerX < 8) {
                    playerX += 0.15;
                }
                
                // Update positions
                player.setAttribute('position', `${playerX} ${playerY} ${playerZ}`);
                camera.setAttribute('position', `${playerX} ${playerY} ${playerZ}`);
                
                // Update obstacles and check collisions
                for (let i = obstacles.length - 1; i >= 0; i--) {
                    let obstacleObj = obstacles[i];
                    let obstacle = obstacleObj.element;
                    
                    if (!obstacle || !obstacle.parentNode) {
                        obstacles.splice(i, 1);
                        continue;
                    }
                    
                    let pos = obstacle.getAttribute('position');
                    if (!pos) continue;
                    
                    // Remove obstacles that are far behind player
                    if (pos.z > playerZ + 20) {
                        obstacle.remove();
                        obstacles.splice(i, 1);
                        continue;
                    }
                    
                    // Check collision with size-aware detection
                    let collisionDistance = obstacleObj.size * 0.8;
                    if (Math.abs(pos.x - playerX) < collisionDistance && 
                        Math.abs(pos.z - playerZ) < collisionDistance &&
                        playerY < pos.y + obstacleObj.size && 
                        playerY + 1.8 > pos.y - obstacleObj.size * 0.5) {
                        gameOver();
                        return;
                    }
                }
            }
            
            // Game over function
            function gameOver() {
                console.log('Game Over! Final Score:', score);
                gameRunning = false;
                
                // Clear intervals
                if (scoreInterval) clearInterval(scoreInterval);
                if (obstacleInterval) clearInterval(obstacleInterval);
                if (gameLoopInterval) clearInterval(gameLoopInterval);
                
                // Hide instructions
                instructionsText.setAttribute('visible', false);
                
                // Show game over screen
                gameOverText.setAttribute('value', 'GAME OVER!');
                gameOverText.setAttribute('visible', true);
                finalScoreText.setAttribute('value', 'Final Score: ' + score);
                finalScoreText.setAttribute('visible', true);
                restartText.setAttribute('visible', true);
            }
            
            // Keyboard controls
            document.addEventListener('keydown', (event) => {
                // Prevent default behavior for game keys
                if (['Space', 'KeyW', 'KeyS', 'KeyA', 'KeyD', 'KeyR'].includes(event.code)) {
                    event.preventDefault();
                }
                
                if (!gameRunning && event.key.toLowerCase() === 'r') {
                    // Remove all obstacles
                    obstacles.forEach(obstacleObj => {
                        if (obstacleObj.element && obstacleObj.element.parentNode) {
                            obstacleObj.element.remove();
                        }
                    });
                    obstacles = [];
                    startGame();
                    return;
                }
                
                if (!gameRunning) return;
                
                // Movement keys
                if (event.key.toLowerCase() === 'a') keys.left = true;
                if (event.key.toLowerCase() === 'd') keys.right = true;
                
                // Jump (Space or W key)
                if ((event.code === 'Space' || event.key.toLowerCase() === 'w') && !isJumping && !isCrouching) {
                    isJumping = true;
                    playerY = 2.8; // jump height
                    
                    setTimeout(() => {
                        if (gameRunning && isJumping) {
                            playerY = isCrouching ? 1.2 : 1.6;
                            isJumping = false;
                        }
                    }, 700); // jump duration
                }
                
                // Crouch (S key)
                if (event.key.toLowerCase() === 's' && !isJumping && !isCrouching) {
                    isCrouching = true;
                    playerY = 1.2;
                    player.setAttribute('height', '1.2');
                }
            });
            
            document.addEventListener('keyup', (event) => {
                // Movement keys
                if (event.key.toLowerCase() === 'a') keys.left = false;
                if (event.key.toLowerCase() === 'd') keys.right = false;
                
                // Stop crouching
                if (event.key.toLowerCase() === 's' && isCrouching && !isJumping) {
                    isCrouching = false;
                    playerY = 1.6;
                    player.setAttribute('height', '1.8');
                }
            });
            
            // Wait for scene to load, then start game
            let scene = document.querySelector('a-scene');
            if (scene.hasLoaded) {
                setTimeout(startGame, 1000);
            } else {
                scene.addEventListener('loaded', () => {
                    setTimeout(startGame, 1000);
                });
            }
        });
    </script>
</body>
</html>
