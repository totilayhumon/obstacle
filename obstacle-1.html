<!DOCTYPE html>
<html>
<head>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <title>Obstacle Avoidance Game</title>
</head>
<body>
    <a-scene background="color: #87CEEB" vr-mode-ui="enabled: false">
        <!-- Player -->
        <a-box id="player" 
               position="0 1 -3" 
               color="blue" 
               width="0.5" 
               height="1" 
               depth="0.5">
        </a-box>
        
        <!-- Ground -->
        <a-plane position="0 0 -4" 
                 rotation="-90 0 0" 
                 width="50" 
                 height="50" 
                 color="green">
        </a-plane>
        
        <!-- Score Display -->
        <a-text id="scoreText" 
                position="-3 3 -5" 
                value="Score: 0" 
                color="black"
                scale="2 2 2">
        </a-text>
        
        <!-- Game Over Screen (hidden initially) -->
        <a-text id="gameOverText" 
                position="0 2 -5" 
                value="" 
                color="red"
                scale="3 3 3"
                visible="false">
        </a-text>
        
        <a-text id="finalScoreText" 
                position="0 1 -5" 
                value="" 
                color="red"
                scale="2 2 2"
                visible="false">
        </a-text>
        
        <a-text id="restartText" 
                position="0 0 -5" 
                value="Press R to Restart" 
                color="white"
                scale="1.5 1.5 1.5"
                visible="false">
        </a-text>

        <!-- Instructions -->
        <a-text id="instructionsText" 
                position="0 -1 -5" 
                value="W/Space: Jump | S: Crouch | Avoid Red Obstacles!" 
                color="yellow"
                scale="1 1 1">
        </a-text>
    </a-scene>

    <script>
        // Wait for A-Frame to fully load
        document.addEventListener('DOMContentLoaded', function() {
            // Game variables
            let score = 0;
            let gameRunning = false;
            let obstacles = [];
            let obstacleSpeed = 0.08;
            let scoreInterval;
            let obstacleInterval;
            let gameLoopInterval;
            
            // Player variables
            let player = document.getElementById('player');
            let isJumping = false;
            let isCrouching = false;
            let playerY = 1; // normal height
            
            // Get text elements
            let scoreText = document.getElementById('scoreText');
            let gameOverText = document.getElementById('gameOverText');
            let finalScoreText = document.getElementById('finalScoreText');
            let restartText = document.getElementById('restartText');
            let instructionsText = document.getElementById('instructionsText');
            
            // Start the game
            function startGame() {
                console.log('Starting game...');
                score = 0;
                gameRunning = true;
                obstacles = [];
                obstacleSpeed = 0.08;
                
                // Hide game over screen
                gameOverText.setAttribute('visible', false);
                finalScoreText.setAttribute('visible', false);
                restartText.setAttribute('visible', false);
                instructionsText.setAttribute('visible', true);
                
                // Reset player position
                player.setAttribute('position', '0 1 -3');
                player.setAttribute('height', '1');
                playerY = 1;
                isJumping = false;
                isCrouching = false;
                
                // Clear any existing intervals
                if (scoreInterval) clearInterval(scoreInterval);
                if (obstacleInterval) clearInterval(obstacleInterval);
                if (gameLoopInterval) clearInterval(gameLoopInterval);
                
                // Start score counter
                scoreInterval = setInterval(() => {
                    if (gameRunning) {
                        score += 10;
                        scoreText.setAttribute('value', 'Score: ' + score);
                        // Increase difficulty over time
                        obstacleSpeed = Math.min(0.15, 0.08 + score * 0.00001);
                    }
                }, 100);
                
                // Start spawning obstacles
                obstacleInterval = setInterval(spawnObstacle, 2500);
                
                // Start game loop
                gameLoopInterval = setInterval(updateGame, 16); // ~60fps
            }
            
            // Spawn obstacles
            function spawnObstacle() {
                if (!gameRunning) return;
                
                let obstacle = document.createElement('a-box');
                let xPos = (Math.random() - 0.5) * 3; // Random x position
                obstacle.setAttribute('position', `${xPos} 1 8`);
                obstacle.setAttribute('color', 'red');
                obstacle.setAttribute('width', '0.8');
                obstacle.setAttribute('height', '1.5');
                obstacle.setAttribute('depth', '0.8');
                obstacle.setAttribute('class', 'obstacle');
                
                document.querySelector('a-scene').appendChild(obstacle);
                obstacles.push(obstacle);
            }
            
            // Move obstacles and check collisions
            function updateGame() {
                if (!gameRunning) return;
                
                for (let i = obstacles.length - 1; i >= 0; i--) {
                    let obstacle = obstacles[i];
                    if (!obstacle || !obstacle.parentNode) {
                        obstacles.splice(i, 1);
                        continue;
                    }
                    
                    let pos = obstacle.getAttribute('position');
                    if (!pos) continue;
                    
                    pos.z -= obstacleSpeed;
                    obstacle.setAttribute('position', pos);
                    
                    // Remove obstacles that are behind player
                    if (pos.z < -5) {
                        obstacle.remove();
                        obstacles.splice(i, 1);
                        continue;
                    }
                    
                    // Check collision with better detection
                    let playerPos = player.getAttribute('position');
                    if (Math.abs(pos.x - playerPos.x) < 0.6 && 
                        Math.abs(pos.z - playerPos.z) < 0.6 &&
                        Math.abs(pos.y - playerPos.y) < 0.8) {
                        gameOver();
                        return;
                    }
                }
            }
            
            // Game over function
            function gameOver() {
                console.log('Game Over! Final Score:', score);
                gameRunning = false;
                
                // Clear intervals
                if (scoreInterval) clearInterval(scoreInterval);
                if (obstacleInterval) clearInterval(obstacleInterval);
                if (gameLoopInterval) clearInterval(gameLoopInterval);
                
                // Hide instructions
                instructionsText.setAttribute('visible', false);
                
                // Show game over screen
                gameOverText.setAttribute('value', 'GAME OVER!');
                gameOverText.setAttribute('visible', true);
                finalScoreText.setAttribute('value', 'Final Score: ' + score);
                finalScoreText.setAttribute('visible', true);
                restartText.setAttribute('visible', true);
            }
            
            // Keyboard controls
            document.addEventListener('keydown', (event) => {
                // Prevent default behavior for game keys
                if (['Space', 'KeyW', 'KeyS', 'KeyR'].includes(event.code)) {
                    event.preventDefault();
                }
                
                if (!gameRunning && event.key.toLowerCase() === 'r') {
                    // Remove all obstacles
                    obstacles.forEach(obstacle => {
                        if (obstacle && obstacle.parentNode) {
                            obstacle.remove();
                        }
                    });
                    obstacles = [];
                    startGame();
                    return;
                }
                
                if (!gameRunning) return;
                
                // Jump (Space or W key)
                if ((event.code === 'Space' || event.key.toLowerCase() === 'w') && !isJumping && !isCrouching) {
                    isJumping = true;
                    playerY = 2.5; // jump height
                    player.setAttribute('position', `0 ${playerY} -3`);
                    
                    setTimeout(() => {
                        if (gameRunning && isJumping) {
                            playerY = 1;
                            player.setAttribute('position', '0 1 -3');
                            isJumping = false;
                        }
                    }, 600); // jump duration
                }
                
                // Crouch (S key)
                if (event.key.toLowerCase() === 's' && !isJumping && !isCrouching) {
                    isCrouching = true;
                    playerY = 0.3;
                    player.setAttribute('position', `0 ${playerY} -3`);
                    player.setAttribute('height', '0.6');
                }
            });
            
            document.addEventListener('keyup', (event) => {
                // Stop crouching
                if (event.key.toLowerCase() === 's' && isCrouching && !isJumping) {
                    isCrouching = false;
                    playerY = 1;
                    player.setAttribute('position', '0 1 -3');
                    player.setAttribute('height', '1');
                }
            });
            
            // Wait for scene to load, then start game
            let scene = document.querySelector('a-scene');
            if (scene.hasLoaded) {
                setTimeout(startGame, 1000);
            } else {
                scene.addEventListener('loaded', () => {
                    setTimeout(startGame, 1000);
                });
            }
        });
    </script>
</body>
</html>
